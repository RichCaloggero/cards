<!DOCTYPE HTML>
<html lang="en">
<head>
<title>Hearts</title>
</head>
<body>
<div class="hand">
<label>hand:
<br><select autofocus id="hand"></select></label>
</div>
<br><button id="startNewRound">Start new round</button>

<hr>
<output id="log"></output>

<script type="module">
import * as hearts from "./hearts.js";
import * as cards from "./cards.js";
import { not, dispatch } from "./utilities.js";

const $hand = document.querySelector("#hand");
const $log = document.querySelector("#log");
const $startNewRound = document.querySelector("#startNewRound");

/// start

setupEventListeners();
hearts.startNewGame(document);

function startNewRound (e) {
dispatch("userCommand", {command: "newRound", data: e});
} // startNewRound

function displayHand (hand) {
fillSelectList($hand, hand);
} // displayHand

function setupEventListeners () {
$hand.addEventListener("click", e => dispatch("userCardPlayed", {card: JSON.parse(e.target.selectedOptions[0].value)}));
$startNewRound.addEventListener("click", startNewRound);

document.addEventListener("keyup", e => {
if (e.key === "Enter") {
e.preventDefault();
e.stopPropagation();
e.stopImmediatePropagation();
$hand.focus();

if (e.ctrlKey) {
$startNewRound.click();
} else if (e.shiftKey) {
const currentTrick = $log.querySelector("#current-trick");
const html = currentTrick.innerHTML;
currentTrick.innerHTML = "";
currentTrick.innerHTML = html;

} else {
$hand.click();
} // if
} // if
}); // enter key clicks

document.addEventListener("updateHand", e => {
//console.log("updateHand: ", e.hand);
displayHand(e.hand)
});

document.addEventListener("trickStart", e => {
$log.insertAdjacentHTML("beforeEnd", '<div id="current-trick">\n</div>\n');
});

document.addEventListener("trickComplete", e => {
$log.querySelectorAll("[data-error]").forEach(x => x.remove());
$log.querySelector("#current-trick").removeAttribute("id");
});

document.addEventListener("userMessage", e => {
$log.querySelectorAll("[data-prompt]").forEach(x => x.remove());
logMessage(e.message, e.options);
});
document.addEventListener("error", e => logMessage(e.message, e.options));
} // setupEventListeners


function fillSelectList($list, items) {
$list.innerHTML = "";
for (const item of items) {
$list.add(new Option(cards.displayCard(item), JSON.stringify(item)));
} // for

return $list;
} // fillSelectList

function displayScores (players) {
logMessage("scores:");
if (players.every(p => p.score === 0)) logMessage("No score yet.");
else logMessage(
players.map(p => `${p.name} has ${p.score} points.`).join("<br>")
);
} // displayScores

function displayYourScore (score) {
if (score > 0) logMessage(`Your score is ${score}.`);
} // displayScore

function clearLog () {document.querySelector("#log").innerHTML = "";}
function logMessage (text, options = []) {
const log = options.includes("trick")? $log.querySelector("#current-trick") : $log;

const prompt = options.includes("prompt")? "data-prompt" : "";
const error = options.includes("error")? "data-error" : "";

log.insertAdjacentHTML("beforeEnd", `<p ${prompt} ${error}>${text}</p>\n`);
if (options.includes("separator")) log.insertAdjacentHTML("beforeEnd", "<hr>\n");
} // logMessage

function processOptions (... options) {
return options.flat()
.filter(x => typeof(x) !== "boolean" && typeof(x) !== "number")
.map(x => typeof(x) === "string"? `data-${x}`
: Object.entries(x).map(entry =>
entry[1]? `data-${entry[0]}="${entry[1]}"`
: `data-${entry[0]}`
).join(" ")
).join(" ");
} // processOptions

function statusMessage (text) {
setTimeout(() => {
document.querySelector("#status").textContent = text;
}, 50);
} // statusMessage

//alert("main module loaded");

</script>

</body>
</html>
