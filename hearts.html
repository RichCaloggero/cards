<!DOCTYPE HTML>
<html lang="en">
<head>
<title>Hearts</title>
</head>
<body>
<div class="hand">
<label>hand:
<br><select autofocus id="hand"></select></label>
</div>
<br><button id="startNewRound">Start new round</button>

<hr>
<output id="log"></output>

<script type="module">
import * as hearts from "./hearts.js";
import * as cards from "./cards.js";
import { not, dispatch } from "./utilities.js";

const $hand = document.querySelector("#hand");
const $log = document.querySelector("#log");
const $startNewRound = document.querySelector("#startNewRound");

/// start

setupEventListeners();
hearts.startNewGame(document);

function startNewRound (e) {
dispatch("userCommand", {command: "newRound", data: e});
} // startNewRound

function displayHand (hand) {
fillSelectList($hand, hand);
} // displayHand

function setupEventListeners () {
$hand.addEventListener("click", e => dispatch("userCardPlayed", {card: JSON.parse(e.target.selectedOptions[0].value)}));
$startNewRound.addEventListener("click", startNewRound);

document.addEventListener("keyup", e => {
if (e.key === "Enter") {
e.preventDefault();
e.stopPropagation();
e.stopImmediatePropagation();
$hand.focus();
if (e.ctrlKey) $startNewRound.click();
else $hand.click();
} // if
}); // enter key clicks

document.addEventListener("updateHand", e => {
//console.log("updateHand: ", e.hand);
displayHand(e.hand)
});

document.addEventListener("trickStart", e => {
/*const separators = [...$log.("hr")].slice(0, -2);
const element = separators[0].nextElementSibling;
do {element.hidden = true;} while (element !== separators[1]);
*/
});

document.addEventListener("trickComplete", e => {
logMessage(""); // separator
});

document.addEventListener("userMessage", e => logMessage(e.message, e.options));
document.addEventListener("error", e => logMessage(e.message));
} // setupEventListeners


function fillSelectList($list, items) {
$list.innerHTML = "";
for (const item of items) {
$list.add(new Option(cards.displayCard(item), JSON.stringify(item)));
} // for

return $list;
} // fillSelectList

function displayScores (players) {
logMessage("scores:");
if (players.every(p => p.score === 0)) logMessage("No score yet.");
else logMessage(
players.map(p => `${p.name} has ${p.score} points.`).join("<br>")
);
} // displayScores

function displayYourScore (score) {
if (score > 0) logMessage(`Your score is ${score}.`);
} // displayScore

function clearLog () {document.querySelector("#log").innerHTML = "";}
function logMessage (text, options) {
$log.querySelectorAll("[data-prompt]").forEach(message => message.remove());

if (text === "") $log.insertAdjacentHTML("beforeEnd", "<hr>\n");
else $log.insertAdjacentHTML("beforeEnd", `<p ${options? processOptions(options) : ""}>${text}</p>\n`);
} // logMessage

function processOptions (... options) {
return options.flat()
.filter(x => typeof(x) !== "boolean" && typeof(x) !== "number")
.map(x => typeof(x) === "string"? `data-${x}`
: Object.entries(x).map(entry =>
entry[1]? `data-${entry[0]}="${entry[1]}"`
: `data-${entry[0]}`
).join(" ")
).join(" ");
} // processOptions

function statusMessage (text) {
setTimeout(() => {
document.querySelector("#status").textContent = text;
}, 50);
} // statusMessage

//alert("main module loaded");

</script>

</body>
</html>
